<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bubble Sculpture (Spinning Rings, Interactive)</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.0.0/dist/aframe-extras.loaders.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
    
    /* Start button overlay */
    #startButton {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 24px;
      background: rgba(250, 122, 174, 0.9);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 9999;
      font-family: Arial, sans-serif;
    }
    
    /* Loading screen */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      transition: opacity 0.5s ease-out;
    }
    
    .bubble-loader {
      position: relative;
      width: 100px;
      height: 100px;
    }
    
    .bubble {
      position: absolute;
      border: 2px solid rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      animation: bubble-pop 2s ease-in-out infinite;
    }
    
    .bubble:nth-child(1) {
      width: 30px;
      height: 30px;
      left: 35px;
      top: 35px;
      animation-delay: 0s;
    }
    
    .bubble:nth-child(2) {
      width: 50px;
      height: 50px;
      left: 25px;
      top: 25px;
      animation-delay: 0.3s;
    }
    
    .bubble:nth-child(3) {
      width: 70px;
      height: 70px;
      left: 15px;
      top: 15px;
      animation-delay: 0.6s;
    }
    
    @keyframes bubble-pop {
      0%, 100% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    #loadingText {
      color: white;
      font-family: Arial, sans-serif;
      font-size: 20px;
      margin-top: 30px;
      text-align: center;
    }
    
    .hidden {
      display: none !important;
    }
  </style>

  <script>
  // Global audio context for mobile
  let audioContext;
  let audioBufferSource;
  let audioBuffer;
  let assetsLoaded = false;
  
  // Track loading progress
  AFRAME.registerComponent('loading-handler', {
    init: function() {
      const scene = this.el;
      const loadingScreen = document.getElementById('loadingScreen');
      const startButton = document.getElementById('startButton');
      
      // Listen for when all assets are loaded
      scene.addEventListener('loaded', function() {
        console.log('Scene loaded');
        assetsLoaded = true;
        
        // Hide loading screen with fade
        if (loadingScreen) {
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            loadingScreen.classList.add('hidden');
          }, 500);
        }
        
        // Show start button
        if (startButton) {
          startButton.style.display = 'block';
        }
      });
    }
  });
  
  // Initialize audio on user interaction
  function initAudio() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Load the pop sound into buffer
    fetch('bubble-pop-06-351337.mp3')
      .then(response => response.arrayBuffer())
      .then(data => audioContext.decodeAudioData(data))
      .then(buffer => {
        audioBuffer = buffer;
        console.log('Audio loaded and ready');
      })
      .catch(e => console.error('Audio load error:', e));
      
    // Also prepare HTML audio pool as backup
    if (!window.audioPool) {
      window.audioPool = [];
      for (let i = 0; i < 10; i++) {
        const audio = new Audio('bubble-pop-06-351337.mp3');
        audio.volume = 0.7;
        // Force load on mobile
        audio.load();
        window.audioPool.push(audio);
      }
    }
    
    // Hide start button
    const btn = document.getElementById('startButton');
    if (btn) btn.style.display = 'none';
  }
  
  // Play sound using Web Audio API (works better on mobile)
  function playPopSound() {
    if (audioContext && audioBuffer) {
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffer;
      const gainNode = audioContext.createGain();
      gainNode.gain.value = 0.7;
      source.connect(gainNode);
      gainNode.connect(audioContext.destination);
      source.start(0);
    } else {
      // Fallback to HTML audio
      const availableAudio = window.audioPool && window.audioPool.find(a => a.paused);
      if (availableAudio) {
        availableAudio.currentTime = 0;
        availableAudio.play().catch(e => console.log('Audio fallback failed'));
      }
    }
  }

  // --------- Force Phong on all GLTF meshes ---------- 
  AFRAME.registerComponent('force-phong', {
    schema: {
      shininess:   { default: 180 },
      baseOpacity: { default: 0.08 }
    },
    init () {
      this.el.addEventListener('model-loaded', () => {
        const obj = this.el.getObject3D('mesh');
        if (!obj) return;

        obj.traverse(n => {
          if (!n.isMesh || !n.material) return;

          const base = n.material;
          const phong = new THREE.MeshPhongMaterial({
            color:       0x222244,
            emissive:    0x060a2e,
            specular:    0xffffff,
            shininess:   this.data.shininess,
            transparent: true,
            opacity:     (typeof base.opacity === 'number')
                           ? base.opacity
                           : this.data.baseOpacity,
            side:        THREE.DoubleSide,
            depthWrite:  false
          });

          if (base.map)       phong.map       = base.map;
          if (base.normalMap) phong.normalMap = base.normalMap;

          n.material = phong;
          n.material.needsUpdate = true;
        });
      });
    }
  });

  // --------- Bubble-pop: hide bubble, spawn random split model, then fade split ----------
  AFRAME.registerComponent('bubble-pop', {
    schema: {
      splitScaleMultiplier: { default: 1.5 },  
      fadeDelay:            { default: 3000 }, 
      fadeDuration:         { default: 3000 }  
    },

    init: function () {
      this.popped = false;
      this.el.classList.add('clickable');
      this.onInteract = this.onInteract.bind(this);
      this.el.addEventListener('click', this.onInteract);
      this.el.addEventListener('touchstart', this.onInteract);
      
      // Array of split model IDs
      this.splitModels = ['#splitModel1', '#splitModel2', '#splitModel3'];
    },

    onInteract: function () {
      this.popBubble();
    },

    popBubble: function () {
      if (this.popped) return;
      this.popped = true;

      const el     = this.el;
      const parent = el.parentNode;
      if (!parent) return;

      // Play sound using our Web Audio API function
      playPopSound();

      const pos   = el.getAttribute('position');
      const rot   = el.getAttribute('rotation');
      const scale = el.getAttribute('scale');

      // Hide the original bubble
      el.setAttribute('visible', false);

      // Randomly select one of the three split models
      const randomSplitModel = this.splitModels[Math.floor(Math.random() * this.splitModels.length)];
      
      // Create a NEW split entity with random model
      const split = document.createElement('a-entity');
      split.setAttribute('gltf-model', randomSplitModel);
      split.setAttribute('force-phong', '');
      split.setAttribute('position', pos);
      split.setAttribute('rotation', rot);

      const finalScale = {
        x: scale.x * this.data.splitScaleMultiplier,
        y: scale.y * this.data.splitScaleMultiplier,
        z: scale.z * this.data.splitScaleMultiplier
      };
      split.setAttribute('scale', `${finalScale.x} ${finalScale.y} ${finalScale.z}`);

      split.setAttribute('animation-mixer', 'loop: once; clampWhenFinished: true');
      parent.appendChild(split);

      split.addEventListener('model-loaded', () => {
        this.startSplitFade(split);
      });
    },

    startSplitFade: function (splitEl) {
      const mesh = splitEl.getObject3D('mesh');
      if (!mesh) return;

      const materials = [];

      mesh.traverse(n => {
        if (n.isMesh && n.material) {
          const mat = n.material;
          mat.transparent = true;
          mat.depthWrite = false;

          materials.push({
            material: mat,
            startOpacity:
              (typeof mat.opacity === 'number') ? mat.opacity : 1
          });
        }
      });

      const fadeDelay    = this.data.fadeDelay;    
      const fadeDuration = this.data.fadeDuration; 

      const startFade = () => {
        const startTime = performance.now();

        const step = (now) => {
          const t = Math.min((now - startTime) / fadeDuration, 1); 

          materials.forEach(entry => {
            entry.material.opacity = entry.startOpacity * (1 - t);
          });

          if (t < 1) {
            requestAnimationFrame(step);
          } else {
            if (splitEl.parentNode) {
              splitEl.parentNode.removeChild(splitEl);
            }
          }
        };

        requestAnimationFrame(step);
      };

      if (fadeDelay > 0) {
        setTimeout(startFade, fadeDelay);
      } else {
        startFade();
      }
    },

    remove: function () {
      this.el.removeEventListener('click', this.onInteract);
      this.el.removeEventListener('touchstart', this.onInteract);
    }
  });

  // --------- Random bubble ring ---------- 
  AFRAME.registerComponent('random-bubble-ring', {
    schema: {
      count:        { default: 8 },
      radius:       { default: 5 },
      y:            { default: 0 },
      scale:        { default: 9 },
      radiusJitter: { default: 1.0 },
      heightJitter: { default: 1.0 },
      depthJitter:  { default: 1.2 },
      scaleJitter:  { default: 0.9 }
    },

    init() {
      const data = this.data;

      for (let i = 0; i < data.count; i++) {
        const angle = (i / data.count) * Math.PI * 2;

        const radialOffset = (Math.random() - 0.5) * data.radiusJitter;
        const r = data.radius + radialOffset;
        let x = Math.cos(angle) * r;
        let z = Math.sin(angle) * r;

        const depthOffset = (Math.random() - 0.5) * data.depthJitter;
        z += depthOffset;

        const y = data.y + (Math.random() - 0.5) * data.heightJitter;

        const scaleFactor = 1 - data.scaleJitter / 2 + Math.random() * data.scaleJitter;
        const finalScale = data.scale * scaleFactor;

        const bubble = document.createElement('a-entity');
        bubble.setAttribute('gltf-model', '#bubbleModel');
        bubble.setAttribute('force-phong', '');
        bubble.setAttribute('bubble-pop', ''); 
        bubble.setAttribute('position', `${x} ${y} ${z}`);
        bubble.setAttribute('scale', `${finalScale} ${finalScale} ${finalScale}`);

        bubble.setAttribute(
          'rotation',
          `${(Math.random() - 0.5) * 20} ${(Math.random()*360).toFixed(1)} ${(Math.random() - 0.5) * 20}`
        );

        this.el.appendChild(bubble);
      }
    }
  });
  </script>

</head>

<body>
  <!-- Loading screen -->
  <div id="loadingScreen">
    <div class="bubble-loader">
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
    </div>
    <div id="loadingText">Loading Bubble World...</div>
  </div>
  
  <!-- Start button for mobile audio (hidden until loaded) -->
  <button id="startButton" onclick="initAudio()" style="display: none;">Tap to Start AR Experience</button>
  
  <a-scene
    loading-handler
    embedded
    vr-mode-ui="enabled:false"
    renderer="logarithmicDepthBuffer:true;antialias:true;colorManagement:true;physicallyCorrectLights:true;toneMapping:ACESFilmic;exposure:1.9"
    arjs="sourceType: webcam; sourceWidth:640; sourceHeight:480; displayWidth: 640; displayHeight: 480; debugUIEnabled:false">

    <!-- Camera with FUSE cursor -->
    <a-camera>
      <a-entity
        cursor="rayOrigin: entity; fuse: true; fuseTimeout: 50"
        raycaster="objects: .clickable; far: 100"
        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
        material="color: #FFFFFF; shader: flat; opacity: 0.9"
        position="0 0 -1">
      </a-entity>
    </a-camera>

    <!-- Assets -->
    <a-assets timeout="60000">
      <a-asset-item id="bubbleModel" src="20polybubble.glb"></a-asset-item>
      <!-- Three different split models -->
      <a-asset-item id="splitModel1" src="split1.glb"></a-asset-item>
      <a-asset-item id="splitModel2" src="split2.glb"></a-asset-item>
      <a-asset-item id="splitModel3" src="split3.glb"></a-asset-item>
      <audio id="popSound" src="bubble-pop-06-351337.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Lights - All restored with nice lighting -->
    <a-entity light="type:ambient; intensity:10; color:#FA7AAE"></a-entity>
    
    <a-entity position="1 2 -1"
              light="type:directional; intensity:8; color:#8BFCFC"></a-entity>
    
    <a-entity position="-2 2 1"
              light="type:directional; intensity:8; color:#E65E63"></a-entity>
    
    <a-entity position="0.5 0.6 -0.8"
              light="type:point; intensity:10; distance:4; color:#FFFFFF"></a-entity>
    
    <a-entity light="type:hemisphere; color:#AAFFFF; groundColor:#0088FF; intensity:2.5"></a-entity>

    <!-- Floating + spinning bubble sculpture -->
    <a-entity
      id="bubble-sculpture"
      position="0 -0.5 -6"
      scale="1 1 1"
      animation__float="property: position.y; from:-0.8; to:0.8; dur:14000; dir:alternate; loop:true; easing:easeInOutSine">

      <!-- Center bubble -->
      <a-entity gltf-model="#bubbleModel"
          force-phong
          bubble-pop="fadeDelay: 3000; fadeDuration: 6000"
          position="0 0 0"
          scale="30 30 30">
      </a-entity>

      <!-- Outer ring -->
      <a-entity
        id="ring-outer"
        animation__spin="property: rotation.y; to:360; loop:true; dur:50000; easing:linear"
        random-bubble-ring="count:10; radius:3; y:0; scale:12;
                            radiusJitter:1.5; heightJitter:1.2; depthJitter:1.5; scaleJitter:0.8">
      </a-entity>

      <!-- Upper ring -->
      <a-entity
        id="ring-upper"
        animation__spin="property: rotation.y; to:-360; loop:true; dur:60000; easing:linear"
        random-bubble-ring="count:8; radius:2.6; y:2.0; scale:12;
                            radiusJitter:0.8; heightJitter:0.8; depthJitter:1.0; scaleJitter:0.4">
      </a-entity>

      <!-- Lower ring -->
      <a-entity
        id="ring-lower"
        animation__spin="property: rotation.y; to:360; loop:true; dur:55000; easing:linear"
        random-bubble-ring="count:8; radius:2.4; y:-2.0; scale:12;
                            radiusJitter:1.0; heightJitter:1.0; depthJitter:1.3; scaleJitter:0.6">
      </a-entity>

    </a-entity>

  </a-scene>
</body>
</html>
